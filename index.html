<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinetaro - Bob's Burgers Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Architects+Daughter&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-yellow: #FEE76D; --accent-red: #F0262A; --louise-green: #95D244;
            --chalkboard-bg: #2D2926; --tina-blue: #9AC7E8; --border-radius: 12px;
            --font-main: 'Quicksand', sans-serif; --font-logo: 'Luckiest Guy', cursive;
            --font-chalk: 'Architects Daughter', cursive;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: var(--font-main); background-color: #1a1a1a; color: white; overflow-x: hidden; }
        #dynamic-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-size: cover; background-position: center; filter: blur(15px) brightness(0.4); transform: scale(1.1); transition: background-image 1s ease-in-out; }
        .app-container { display: flex; flex-direction: column; align-items: center; padding: 1rem; min-height: 100vh; background: radial-gradient(circle at center, transparent, rgba(0,0,0,0.8)); }
        header { text-align: center; margin-bottom: 2rem; position: relative; }
        h1 { font-family: 'Luckiest Guy', cursive; color: var(--primary-yellow); text-shadow: 4px 4px 0px var(--accent-red); font-size: clamp(2.5rem, 8vw, 4.5rem); margin: 0; letter-spacing: 3px; text-transform: uppercase; }
        .burger-badge { display: inline-block; background: var(--accent-red); color: white; font-family: var(--font-chalk); padding: 5px 15px; transform: rotate(-3deg); border: 2px solid white; box-shadow: 4px 4px 0px rgba(0,0,0,0.3); font-size: 1.2rem; margin-top: -10px; }
        .player-wrapper { width: 100%; max-width: 1100px; background: var(--chalkboard-bg); border: 8px solid #444; border-radius: var(--border-radius); box-shadow: 0 25px 60px rgba(0,0,0,0.8); overflow: hidden; position: relative; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .controls-shelf { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 15px; background: #222; border-top: 5px solid var(--accent-red); }
        @media (min-width: 850px) { .controls-shelf { grid-template-columns: 280px 1fr; padding: 20px; } }
        .side-panel { display: flex; flex-direction: column; gap: 10px; }
        .control-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 1px dashed rgba(255,255,255,0.2); }
        .label-text { font-family: var(--font-chalk); color: var(--primary-yellow); font-size: 1.1rem; margin-bottom: 8px; display: block; }
        select, button { width: 100%; padding: 10px; background: #333; color: white; border: 2px solid var(--louise-green); border-radius: 6px; font-family: var(--font-main); cursor: pointer; }
        .nav-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .nav-btn { background: var(--accent-red); border: none; color: white; font-family: var(--font-logo); transition: 0.2s; }
        .episode-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 8px; max-height: 350px; overflow-y: auto; padding-right: 10px; }
        .ep-btn { background: #444; border: 3px solid #666; padding: 12px 0; text-align: center; border-radius: 4px; cursor: pointer; font-family: var(--font-logo); position: relative; transition: all 0.3s ease; }
        .ep-btn.watched { opacity: 0.4; filter: grayscale(0.8); border-color: #222; }
        .ep-btn.active { background: var(--primary-yellow); color: #000; opacity: 1; transform: scale(1.1); z-index: 2; box-shadow: 0 0 20px var(--primary-yellow); }
        .login-toggle { display: flex; gap: 5px; margin-bottom: 10px; }
        .active-user { border-color: var(--louise-green) !important; color: var(--louise-green); font-weight: bold; }
    </style>
</head>
<body>
    <div id="dynamic-bg"></div>
    <div class="app-container">
        <header>
            <h1>BOB'S BURGERS</h1>
            <div class="burger-badge">TODAY'S SPECIAL: THE FAIL-SAFE SLIDER</div>
        </header>

        <main class="player-wrapper">
            <div class="video-container"><iframe id="main-player" allowfullscreen></iframe></div>
            <div class="controls-shelf">
                <div class="side-panel">
                    <div class="control-card">
                        <label class="label-text">Clock In</label>
                        <div class="login-toggle">
                            <button id="btn-guest" onclick="switchUser('guest')">CUSTOMER</button>
                            <button id="btn-user1" onclick="switchUser('user1')">STAFF (U1)</button>
                        </div>
                        <div id="status-msg" style="font-size: 0.7rem; font-family: var(--font-chalk); color: var(--tina-blue); text-align: center;"></div>
                    </div>
                    <div class="control-card"><label class="label-text">Server</label>
                        <select id="server-select">
                            <option value="https://vidsrc.to/embed/tv/">Server 1 (VidSrc.to)</option>
                            <option value="https://vidsrc.me/embed/tv/">Server 2 (VidSrc.me)</option>
                        </select>
                    </div>
                    <div class="control-card" style="text-align:center;"><label class="label-text">Mobile Handoff</label>
                        <div id="qrcode" style="background:white; padding:5px; display:inline-block; border-radius:4px;"></div>
                    </div>
                    <div class="control-card"><label class="label-text">Season</label><select id="season-select"></select></div>
                    <div class="nav-btns">
                        <button class="nav-btn" onclick="navEpisode(-1)">PREV</button>
                        <button class="nav-btn" onclick="navEpisode(1)">NEXT</button>
                    </div>
                </div>
                <div class="control-card"><label class="label-text">Order Up: Episode List</label><div id="episode-list" class="episode-grid"></div></div>
            </div>
        </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="module">
    // Import v12.7.0 SDKs from the CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

    // Your new Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyC5Ol2nQZ_DVFg2d8Kan5K9Z-IZAQHHqd0",
        authDomain: "bobby-3c12e.firebaseapp.com",
        projectId: "bobby-3c12e",
        storageBucket: "bobby-3c12e.firebasestorage.app",
        messagingSenderId: "587264926884",
        appId: "1:587264926884:web:daa3f6d933f5e96cd8b231",
        measurementId: "G-YX9WVTFQ7F"
    };

    // Initialize Firebase services
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const analytics = getAnalytics(app); // Analytics is now active

    // CONFIG for TMDB
    const CONFIG = {
        TMDB_ID: 32726, 
        API_KEY: "add81e51153d96a2f9d7b2023943a38b" 
    };

    let currentUser = localStorage.getItem('bobs_user') || 'guest';
    let currentProgress = { s: 1, e: 1 };
    let servedEpisodes = JSON.parse(localStorage.getItem('bobs_served_list')) || [];

    const player = document.getElementById('main-player');
    const seasonSelect = document.getElementById('season-select');
    const episodeList = document.getElementById('episode-list');
    const serverSelect = document.getElementById('server-select');

    window.switchUser = async (name) => {
        currentUser = name;
        localStorage.setItem('bobs_user', name);
        document.getElementById('btn-guest').className = name === 'guest' ? 'active-user' : '';
        document.getElementById('btn-user1').className = name === 'user1' ? 'active-user' : '';
        
        if (name === 'user1') {
            document.getElementById('status-msg').textContent = "Clocking in Staff...";
            await syncFromCloud();
        } else {
            document.getElementById('status-msg').textContent = "Eating as Guest";
            currentProgress = JSON.parse(localStorage.getItem('bobs_save')) || { s: 1, e: 1 };
            seasonSelect.value = currentProgress.s;
            await loadEpisodes(currentProgress.s, currentProgress.e);
            playEpisode(currentProgress.s, currentProgress.e, false);
        }
    };

    async function syncFromCloud() {
        try {
            const userDoc = await getDoc(doc(db, "users", currentUser));
            if (userDoc.exists()) {
                const data = userDoc.data();
                currentProgress = data.lastWatched || { s: 1, e: 1 };
                servedEpisodes = data.servedEpisodes || [];
                seasonSelect.value = currentProgress.s; 
                await loadEpisodes(currentProgress.s, currentProgress.e);
                playEpisode(currentProgress.s, currentProgress.e, false);
                document.getElementById('status-msg').textContent = "Staff Progress Loaded!";
            } else {
                document.getElementById('status-msg').textContent = "No cloud data found.";
                await loadEpisodes(seasonSelect.value || 1, 1);
            }
        } catch (e) {
            document.getElementById('status-msg').textContent = "Sync failed. Check Firestore setup.";
            console.error(e);
        }
    }

    async function loadSeasons() {
        try {
            const res = await fetch(`https://api.themoviedb.org/3/tv/${CONFIG.TMDB_ID}?api_key=${CONFIG.API_KEY}`);
            if (!res.ok) throw new Error("API Key Invalid");
            const data = await res.json();
            if (data.seasons) {
                seasonSelect.innerHTML = data.seasons
                    .filter(s => s.season_number > 0)
                    .map(s => `<option value="${s.season_number}">Season ${s.season_number}</option>`).join('');
            }
            if (data.backdrop_path) document.getElementById('dynamic-bg').style.backgroundImage = `url(https://image.tmdb.org/t/p/original${data.backdrop_path})`;
        } catch (e) {
            console.warn("Using fallback seasons due to API issues.");
            let opts = "";
            for(let i=1; i<=15; i++) opts += `<option value="${i}">Season ${i}</option>`;
            seasonSelect.innerHTML = opts;
        }
    }

    async function loadEpisodes(sNum, activeEp = 1) {
        try {
            const res = await fetch(`https://api.themoviedb.org/3/tv/${CONFIG.TMDB_ID}/season/${sNum}?api_key=${CONFIG.API_KEY}`);
            const data = await res.json();
            episodeList.innerHTML = '';
            if (data.episodes) {
                data.episodes.forEach(ep => {
                    const isWatched = servedEpisodes.includes(`s${sNum}e${ep.episode_number}`);
                    const btn = document.createElement('div');
                    btn.className = `ep-btn ${isWatched ? 'watched' : ''} ${ep.episode_number == activeEp ? 'active' : ''}`;
                    btn.textContent = ep.episode_number;
                    btn.onclick = () => playEpisode(sNum, ep.episode_number);
                    episodeList.appendChild(btn);
                });
            }
        } catch (e) { console.error(e); }
    }

    async function playEpisode(s, e, updateStorage = true) {
        const epId = `s${s}e${e}`;
        if (!servedEpisodes.includes(epId)) servedEpisodes.push(epId);
        currentProgress = { s, e };
        player.src = `${serverSelect.value}${CONFIG.TMDB_ID}/${s}/${e}`;
        
        const handoffURL = `${window.location.origin}${window.location.pathname}?s=${s}&e=${e}&u=${currentUser}`;
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { text: handoffURL, width: 100, height: 100 });

        if (updateStorage) {
            localStorage.setItem('bobs_save', JSON.stringify(currentProgress));
            localStorage.setItem('bobs_served_list', JSON.stringify(servedEpisodes));
            if (currentUser === 'user1') {
                await setDoc(doc(db, "users", currentUser), { lastWatched: { s, e }, servedEpisodes });
            }
        }
        document.querySelectorAll('.ep-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent == e);
            if (servedEpisodes.includes(`s${s}e${btn.textContent}`)) btn.classList.add('watched');
        });
    }

    async function initApp() {
        await loadSeasons();
        const params = new URLSearchParams(window.location.search);
        if (params.get('u')) currentUser = params.get('u');
        await switchUser(currentUser);
        if (params.get('s')) playEpisode(parseInt(params.get('s')), parseInt(params.get('e')));
    }

    window.navEpisode = (dir) => {
        let nextE = parseInt(currentProgress.e) + dir;
        if (nextE >= 1) playEpisode(currentProgress.s, nextE);
    };

    seasonSelect.onchange = (e) => loadEpisodes(e.target.value, 1);
    initApp();
</script>
</body>
</html>

